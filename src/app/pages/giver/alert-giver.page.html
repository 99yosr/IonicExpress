<ion-header translucent="true">
  <ion-toolbar>
    <ion-title>Active alerts</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="logout()">Logout</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen>
  <ion-refresher slot="fixed" (ionRefresh)="refresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="map-wrapper">
    <div class="map-container" #mapRef></div>

    @if (loadingAlerts) {
      <div class="loading-overlay">
        <ion-spinner name="crescent"></ion-spinner>
      </div>
    }

    @if (alerts.length) {
      <div class="alerts-sheet">
        <h2>Alerts nearby</h2>
        <ion-list lines="none">
          @for (alert of alerts; track alert._id) {
            <ion-item>
              <ion-label>
                <h3>{{ alert.type }}</h3>
                <p>{{ alert.description }}</p>
                <p class="meta">
                  Status: {{ alert.status === 'accepted' ? 'Help on the way' : alert.status | titlecase }} Â·
                  {{ alert.createdAt | date: 'short' }}
                </p>
              </ion-label>
            </ion-item>
          }
        </ion-list>
      </div>
    }
  </div>

  <ion-fab
    vertical="bottom"
    horizontal="end"
    slot="fixed"
    class="alerts-fab"
    [class.alerts-fab--raised]="alerts.length"
  >
    <ion-fab-button color="danger" (click)="launchAlert()">
      <span class="fab-label">Launch alert</span>
    </ion-fab-button>
  </ion-fab>

  <ion-modal
    [isOpen]="createModalOpen"
    [backdropDismiss]="!createLoading"
    (willDismiss)="onModalDismiss()"
  >
    <ion-header>
      <ion-toolbar>
        <ion-title>Send alert</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeCreateModal()" [disabled]="createLoading">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <form [formGroup]="createForm" (ngSubmit)="submitAlert()" novalidate>
        <ion-list lines="inset">
          <ion-item>
            <ion-label position="stacked">Type</ion-label>
            <ion-select formControlName="type" interface="popover">
              <ion-select-option value="medical">Medical</ion-select-option>
              <ion-select-option value="fire">Fire</ion-select-option>
              <ion-select-option value="accident">Accident</ion-select-option>
              <ion-select-option value="other">Other</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Description</ion-label>
            <ion-textarea
              formControlName="description"
              rows="4"
              autoGrow="true"
              placeholder="Describe the situation..."
              required
            ></ion-textarea>
          </ion-item>
          @if (
            createForm.controls.description.invalid &&
            (createForm.controls.description.dirty ||
              createForm.controls.description.touched)
          ) {
            <ion-text color="danger">
              Please include a brief description.
            </ion-text>
          }

          <ion-item>
            <ion-label position="stacked">Number injured (optional)</ion-label>
            <ion-input type="number" formControlName="numInjured" min="0"></ion-input>
          </ion-item>
        </ion-list>

        <div class="photo-block">
          <ion-button type="button" expand="block" fill="outline" (click)="selectPhoto()" [disabled]="createLoading">
            <ion-icon name="camera" slot="start"></ion-icon>
            Add photo
          </ion-button>
          @if (photoPreview) {
            <img [src]="photoPreview" alt="Alert photo preview" class="photo-preview" />
          }
          @if (photoPreview) {
            <ion-button
              type="button"
              fill="clear"
              size="small"
              color="medium"
              (click)="clearPhoto()"
            >
              Remove photo
            </ion-button>
          }
        </div>

        @if (createError) {
          <ion-text color="danger">{{ createError }}</ion-text>
        }

        <ion-button
          type="submit"
          expand="block"
          class="ion-margin-top"
          [disabled]="createForm.invalid || createLoading"
        >
          @if (createLoading) {
            <ion-spinner slot="start"></ion-spinner>
          }
          Send alert
        </ion-button>
      </form>
    </ion-content>
  </ion-modal>
</ion-content>
